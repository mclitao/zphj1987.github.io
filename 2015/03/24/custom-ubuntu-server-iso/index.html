<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  
  <title>custom-ubuntu-server-iso | zphj1987&#39;Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  
    <meta name="author" content="zphj1987">
  
  
    <meta name="description" content="Remastering the Ubuntu Desktop ISO is easy considering the existing graphical tools but did you ever wanted to build your custom Ubuntu Server Edition ISO ?
Preparing the EnvironmentYou’ll need a clea">
  
  <meta name="description" content="Remastering the Ubuntu Desktop ISO is easy considering the existing graphical tools but did you ever wanted to build your custom Ubuntu Server Edition ISO ?
Preparing the EnvironmentYou’ll need a clea">
<meta property="og:type" content="article">
<meta property="og:title" content="custom-ubuntu-server-iso">
<meta property="og:url" content="http://yoursite.com/2015/03/24/custom-ubuntu-server-iso/index.html">
<meta property="og:site_name" content="zphj1987'Blog">
<meta property="og:description" content="Remastering the Ubuntu Desktop ISO is easy considering the existing graphical tools but did you ever wanted to build your custom Ubuntu Server Edition ISO ?
Preparing the EnvironmentYou’ll need a clea">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="custom-ubuntu-server-iso">
<meta name="twitter:description" content="Remastering the Ubuntu Desktop ISO is easy considering the existing graphical tools but did you ever wanted to build your custom Ubuntu Server Edition ISO ?
Preparing the EnvironmentYou’ll need a clea">
  
  
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  
  
<script type="text/javascript">
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?252ba55374ee0e63b03196973bb9b776";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

</head>

<body>
  <div class="wrapper">
    <header id="header">
  <div class="title">
    <h1><a href="/">zphj1987&#39;Blog</a></h1>
    <p><a href="/">现在所学，终有所用</a></p>
  </div>
  <nav class="nav">
    <ul>
      
        <li><a href="/">Home</a></li>
      
        <li><a href="/archives">Archives</a></li>
      
        <li><a href="/atom.xml">rss</a></li>
      
        <li><a href="/about">About</a></li>
      
      
    </ul>
    <div class="clearfix"></div>
  </nav>
  <div class="clearfix"></div>
</header>
    <div class="content"><article class="post">
  <header>
    
      <div class="icon"></div>
      <a href="/2015/03/24/custom-ubuntu-server-iso/">
  <time datetime="2015-03-24T00:58:38.000Z">
    2015-03-24
  </time>
</a>
    
    
  
    <h1 class="title">custom-ubuntu-server-iso</h1>
  

  </header>
  
  <div class="entry">
    
      <p>Remastering the Ubuntu Desktop ISO is easy considering the existing graphical tools but did you ever wanted to build your custom Ubuntu Server Edition ISO ?</p>
<p>Preparing the Environment<br>You’ll need a clean copy of the Ubuntu Server ISO that you want to customize. Since 10.04 is the latest Ubuntu version I will write down my examples using it but everything should work pretty much unchanged for older or newer versions.</p>
<p>After you have you have the original iso image downloaded, make a copy it’s contents so we can later apply our patching there.</p>
<p>cd /home/rgavril/Work</p>
<p>mkdir original-iso custom-iso<br>mount -o loop ./ubuntu-10.04-server-i386.iso ./original-iso</p>
<a id="more"></a>
<p>cp -r ./original-iso/* ./custom-iso/<br>cp -r ./original-iso/.disk/ ./custom-iso/</p>
<p>umount ./original-iso/<br>Adding a Boot Menu Option<br>For start let’s add a option to the cd boot menu. You’ll need to modify isolinux/text.cfg and insert the next lines between default install and label install:</p>
<p>label custom<br>  menu label ^Install Custom Ubuntu Server<br>  kernel /install/vmlinuz<br>  append  file=/cdrom/preseed/ubuntu-custom.seed initrd=/install/initrd.gz quiet ks=cdrom:/isolinux/ks-custom.cfg —<br>This newly added block is very similar to the label install one. The two important additions being the file and ks boot options that I will later explain.</p>
<p>If you want to make your menu option the default one, you only need to change the default install to default custom or whatever you used as a label.</p>
<p>Kickstart-ing<br>KickStart is a unattended installation method developed by Red Hat and later adopted and adapted by Debian and Ubuntu. To keep it short, the Ubuntu installer can read an external file and figure out how to configure the system (create partitions, set timezones and keyboard layouts ..) without asking the user.</p>
<p>There’s no need to write everything using a text editor as we have a powerful tool to create such configuration files:</p>
<p>apt-get install system-config-kickstart<br>ksconfig<br>After creating your ks.cfg file, you will need to move it on the custom-iso/ at the path specified in text.cfg. That’s the location where the ubuntu installer will look for it.</p>
<p>cp ks.cfg custom-iso/isolinux/ks-custom.cfg<br>Preseeding Packages<br>The installer in not the only one that may present questions to the user. When installed, some package rely on the user to explicitly set different parameters.</p>
<p>Preseeding is the action of setting, in advance, this kind of package parameters. It’s a very powerful method that you can use even for replacing kickstart. In this article, I’ll use it as a addition to kickstart as is more harder to tune the ubuntu installer, mostly because it lacks a gui.</p>
<p>The params can be set trough a configuration file specified by the file in text.cfg. I recommend starting with the existing preseed file from the original cd:</p>
<p>cp custom-iso/preseed/ubuntu-server.seed custom-iso/preseed/ubuntu-custom.seed<br>Using debconf-get-selections from the debconf-utils package you can look over a running ubuntu system to figure out what parameters you can tune. For example here are the possible configuration settings for the openssh-server together with their values :</p>
<p>root@xps1330:~/work# debconf-get-selections | grep openssh<br>openssh-server    ssh/vulnerable_host_keys    note<br>openssh-server    ssh/use_old_init_script    boolean    true<br>openssh-server    ssh/encrypted_host_key_but_no_keygen    note<br>openssh-server    ssh/disable_cr_auth    boolean    false<br>Adding Extra Packages<br>Ubuntu’s ksconfig utility does’n provide a way to select extra packages as the Package Selection is not working. In order to specify what extra packages you want to install you’ll need to modify the kickstart configuration file by hand.</p>
<p>vim custom-iso/isolinux/ks-custom.cfg<br>Depending on the extra packages that you want to install by default, add some similar lines to the end of the file :</p>
<p>%packages<br>openssh-server<br>asterisk<br>asterisk-mysql<br>Offline Installation<br>When having additional packages installed by default, there’s a big chance are that those particular packages may not be on the default iso. If you have an active internet connection during the install, the packages will be automatically fetched from the online repositories. But if you’re internet connection is not working, the install process will fail. In order to prevent the problem and create a offline installable cd, you’ll need to perform some extra steps.</p>
<p>You’ll need to downloading and copying the extra debs and all their dependencies on your iso. Please note that in doing so you may increase the iso size a lot and be forced to use a dvd.</p>
<p>It’s very hard to figure out what debs are missing from your iso. In order to make a list of needed debs I use the following steps:</p>
<p>On a virtual machine, install a ubuntu server using the original cd image.<br>Boot the newly installed ubuntu server, make sure the cd is mountable and cdrom directive is available in sources.list<br>Do an apt-get install of the extra packages that I want to have installed by default<br>Make a backup of the debs located in /var/cache/apt/archives as this are the missing ones that need to be on the iso<br>Considering that you downloaded the extra packages, and that they are located in the extradebs/ directory within the current folder. You will need to copy them on the cd and create a repository by running this commands:</p>
<p>mkdir -p custom-iso/dists/stable/extras/binary-i386<br>mkdir -p custom-iso/pool/extras/</p>
<p>cp ./extradebs/*.deb custom-iso/pool/extras/</p>
<p>pushd custom-iso<br>apt-ftparchive packages ./pool/extras/ &gt; dists/stable/extras/binary-i386/Packages<br>gzip -c ./dists/stable/extras/binary-i386/Packages | tee ./dists/stable/extras/binary-i386/Packages.gz &gt; /dev/null<br>popd<br>Generating the new ISO<br>All you need to do now is build you new iso and give it a test drive to see how it works:</p>
<p>mkisofs -J -l -b isolinux/isolinux.bin -no-emul-boot -boot-load-size 4 -boot-info-table -z -iso-level 4 -c isolinux/isolinux.cat -o ./ubuntu-10.04-custom-i386.iso custom-iso/</p>

    
  </div>
  <footer>
    
      
      
    
    <div class="clearfix"></div>
  </footer>
</article>


<section id="comment">
  <h1 class="title">评论</h1>
  <div class="ds-thread" data-thread-key="2015/03/24/custom-ubuntu-server-iso/"  data-title="custom-ubuntu-server-iso">
  </div>
</section>
</div>
  </div>
  <footer id="footer"><div class="copyright">
  
  &copy; 2015 <a href="/">zphj1987</a>
  
</div>
<div class="theme-copyright">
  Theme by <a href="https://github.com/orderedlist" target="_blank">orderedlist</a>
   | 
  Redesign by <a href="http://heroicyang.com/" target="_blank">Heroic Yang</a>
</div>
<div class="clearfix"></div></footer>
  <script src="/js/jquery.min.js"></script>
<script src="/js/scale.fix.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>


<script type="text/javascript">
  var duoshuoQuery = { short_name: 'zphj1987' };
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';
    ds.async = true;
    ds.src = 'http://static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script>



<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
  (function($){
    $('.fancybox').fancybox();
  })(jQuery);
</script>


<div id="totop" style="position:fixed;bottom:150px;right:50px;cursor: pointer;">
<a title="Top"><img src="/imgs/scrollup.png"/></a>
</div>
<script src="/js/totop.js"></script>

</body>
</html>